<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chun 財務手帳 | 跨裝置專業版</title>
    
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%238c7662'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='40' font-weight='100' fill='white' letter-spacing='5'%3ECHUN%3C/text%3E%3C/svg%3E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#8c7662">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100;300;400;500;700&display=swap');
        
        :root {
            --bg: #fdfaf5;
            --primary: #8c7662;
            --text: #37352f;
            --sub: #9b9a97;
            --card: #ffffff;
            --red: #eb5757;
            --green: #27ae60;
            --blue: #2f80ed;
            --orange: #f2994a;
            --border: rgba(140, 118, 98, 0.1);
            --content-width: 1100px;
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; line-height: 1.6; overflow-x: hidden; }

        /* Splash Screen */
        #splash {
            position: fixed; inset: 0; background: var(--bg); z-index: 99999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 1; transition: opacity 0.6s ease;
        }
        .splash-logo { font-size: 42px; font-weight: 100; color: var(--primary); letter-spacing: 15px; margin-bottom: 25px; }

        /* Layout Container */
        #app-content { display: none; opacity: 0; transition: opacity 0.5s ease; max-width: var(--content-width); margin: 0 auto; }
        #app-content.visible { display: block; opacity: 1; }

        .page { padding: 40px 24px 140px; display: none; }
        .page.active { display: block; }

        .brand { font-size: 32px; font-weight: 100; color: var(--primary); letter-spacing: 10px; text-align: center; margin: 30px 0 40px; }
        
        /* Dashboard & Grid System */
        .dashboard-container { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 25px; }
        @media (min-width: 768px) { .dashboard-container { grid-template-columns: 2fr 1fr; } }

        .dashboard {
            background: var(--primary); color: white; border-radius: 30px; padding: 35px 24px;
            box-shadow: 0 15px 30px rgba(140, 118, 98, 0.15);
        }
        .dash-label { font-size: 11px; opacity: 0.7; text-align: center; letter-spacing: 1px; }
        .dash-value { font-size: clamp(32px, 5vw, 48px); font-weight: 300; text-align: center; margin: 8px 0 25px; }
        .dash-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; border-top: 1px solid rgba(255,255,255,0.15); padding-top: 20px; }
        .grid-item { text-align: center; }
        .grid-v { font-size: 14px; font-weight: 500; }
        .grid-l { font-size: 9px; opacity: 0.6; margin-top: 4px; }

        /* Grid for Cards */
        .responsive-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
        .month-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        @media (min-width: 600px) { .month-grid { grid-template-columns: repeat(4, 1fr); } }
        @media (min-width: 900px) { .month-grid { grid-template-columns: repeat(6, 1fr); } }

        .section-header { font-size: 12px; font-weight: 700; color: var(--sub); letter-spacing: 2px; margin: 40px 0 15px 5px; display: flex; justify-content: space-between; align-items: center; }
        .action-text { color: var(--primary); cursor: pointer; font-size: 11px; transition: 0.2s; }
        .action-text:hover { opacity: 0.7; }
        
        .card { background: var(--card); border-radius: 20px; padding: 22px; margin-bottom: 15px; border: 1px solid var(--border); transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }

        .quick-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .quick-btn { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 20px; text-align: center; cursor: pointer; transition: 0.2s; }
        .quick-btn:hover { border-color: var(--primary); background: #fdfaf5; }
        .quick-btn span { display: block; font-size: 10px; color: var(--sub); }
        .quick-btn strong { display: block; color: var(--primary); font-size: 15px; margin-top: 4px; }

        /* Modal Overlays */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 30px; width: 95%; max-width: 500px; padding: 35px 24px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        @media (max-width: 600px) { .modal { align-items: flex-end; } .modal-content { border-radius: 30px 30px 0 0; width: 100%; } }

        /* Inputs */
        input, select, textarea { width: 100%; padding: 18px; border-radius: 16px; border: 1px solid #eee; font-size: 16px; margin-bottom: 12px; font-family: inherit; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(140, 118, 98, 0.1); }
        .btn { width: 100%; padding: 18px; border-radius: 18px; border: none; background: var(--primary); color: white; font-weight: 700; font-size: 16px; cursor: pointer; transition: 0.3s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-ghost { background: transparent; color: var(--sub); margin-top: 10px; }

        /* Navigation Bar (Floating Style on Desktop) */
        .nav { position: fixed; bottom: 0; left: 0; right: 0; height: 80px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-top: 1px solid #eee; display: flex; justify-content: center; align-items: center; padding-bottom: env(safe-area-inset-bottom); z-index: 100; }
        .nav-inner { width: 100%; max-width: 500px; display: flex; }
        .nav-item { flex: 1; text-align: center; color: var(--sub); font-size: 11px; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--primary); font-weight: 700; }

        @media (min-width: 1024px) {
            .nav { width: auto; bottom: 30px; left: 50%; transform: translateX(-50%); border: 1px solid var(--border); border-radius: 50px; padding: 0 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
            .nav-inner { width: 300px; }
        }

        /* Tags and Labels */
        .tag { font-size: 9px; padding: 3px 8px; border-radius: 50px; font-weight: 700; margin-right: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .t-fixed { background: #fdeaea; color: #d32f2f; }
        .t-save { background: #e8f5e9; color: #2e7d32; }
        .t-debt { background: #fff1f1; color: var(--red); border: 1px solid var(--red); }
        .t-repay { background: #f1fff1; color: var(--green); border: 1px solid var(--green); }

        /* Buttons Group */
        .mode-toggle-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .mode-btn { padding: 14px; border-radius: 14px; text-align: center; font-size: 13px; font-weight: 600; border: 1px solid #eee; transition: 0.2s; cursor: pointer; }
        .mode-btn.debt.active { border-color: var(--red); color: var(--red); background: #fff5f5; }
        .mode-btn.repay.active { border-color: var(--green); color: var(--green); background: #f5fff5; }

        .chip-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .chip { padding: 9px 18px; background: #f0f0f0; border-radius: 50px; font-size: 13px; cursor: pointer; transition: 0.2s; }
        .chip:hover { background: #e5e5e5; }
        .chip.active { background: var(--primary); color: white; }

        /* Calculator Position Adjust */
        #calc-toggle {
            position: fixed; right: 24px; bottom: 100px; width: 56px; height: 56px;
            background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 20px rgba(140, 118, 98, 0.4); z-index: 1500; cursor: pointer; color: white; transition: 0.3s;
        }
        @media (min-width: 1024px) { #calc-toggle { bottom: 40px; right: 40px; } }
        #calc-toggle:hover { transform: scale(1.1); }
        
        #calc-box {
            position: fixed; right: 24px; bottom: 170px; width: 300px; background: white;
            border-radius: 24px; box-shadow: 0 15px 40px rgba(0,0,0,0.15); display: none;
            flex-direction: column; overflow: hidden; z-index: 1600; border: 1px solid var(--border);
        }
        @media (min-width: 1024px) { #calc-box { bottom: 110px; right: 40px; } }

        .summary-card { background: #fdfaf5; border: 1px solid var(--border); padding: 25px; border-radius: 24px; margin-top: 30px; }
        
        /* Grid for Detail Page */
        .detail-main-grid { display: grid; grid-template-columns: 1fr; gap: 24px; }
        @media (min-width: 1024px) { .detail-main-grid { grid-template-columns: 1.2fr 1.8fr; } }
    </style>
</head>
<body>

    <div id="splash">
        <div class="splash-logo">CHUN</div>
        <div style="font-weight: 300; letter-spacing: 2px;">理財，是為了更有餘裕的生活</div>
    </div>

    <!-- Calculator Widget -->
    <div id="calc-toggle" onclick="ui.toggleCalc()">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M19,2H5A3,3,0,0,0,2,5V19a3,3,0,0,0,3,3H19a3,3,0,0,0,3,-3V5A3,3,0,0,0,19,2ZM7,7H9V9H7V7ZM7,11H9V13H7V11ZM7,15H9V17H7V15ZM17,17H11V15H17V17ZM17,13H15V11H17V13ZM17,9H15V7H17V9ZM13,9H11V7H13V9ZM13,13H11V11H13V13Z"/></svg>
    </div>
    <div id="calc-box">
        <div id="calc-display" style="background:#f8f8f8; padding:30px 20px; text-align:right; font-size:28px; font-weight:300;">0</div>
        <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:1px; background:#eee;">
            <button onclick="calc.clear()" style="border:none;background:white;padding:20px;color:var(--red)">C</button>
            <button onclick="calc.del()" style="border:none;background:white;padding:20px;">←</button>
            <button onclick="calc.input('/')" style="border:none;background:white;padding:20px;">÷</button>
            <button onclick="calc.input('*')" style="border:none;background:white;padding:20px;">×</button>
            <!-- Rows 7-9 etc. (Simplified for example) -->
            <button onclick="calc.input('7')" style="border:none;background:white;padding:20px;">7</button>
            <button onclick="calc.input('8')" style="border:none;background:white;padding:20px;">8</button>
            <button onclick="calc.input('9')" style="border:none;background:white;padding:20px;">9</button>
            <button onclick="calc.input('-')" style="border:none;background:white;padding:20px;">-</button>
            <button onclick="calc.input('4')" style="border:none;background:white;padding:20px;">4</button>
            <button onclick="calc.input('5')" style="border:none;background:white;padding:20px;">5</button>
            <button onclick="calc.input('6')" style="border:none;background:white;padding:20px;">6</button>
            <button onclick="calc.input('+')" style="border:none;background:white;padding:20px;">+</button>
            <button onclick="calc.input('1')" style="border:none;background:white;padding:20px;">1</button>
            <button onclick="calc.input('2')" style="border:none;background:white;padding:20px;">2</button>
            <button onclick="calc.input('3')" style="border:none;background:white;padding:20px;">3</button>
            <button onclick="calc.equal()" style="grid-row:span 2; border:none;background:var(--primary);color:white;">=</button>
            <button onclick="calc.input('0')" style="grid-column:span 2; border:none;background:white;padding:20px;">0</button>
            <button onclick="calc.input('.')" style="border:none;background:white;padding:20px;">.</button>
        </div>
    </div>

    <div id="app-content">
        <!-- Home Page -->
        <div id="page-home" class="page active">
            <div class="brand">CHUN</div>
            
            <div class="dashboard-container">
                <div class="dashboard">
                    <div class="dash-label">總帳戶資產淨值</div>
                    <div class="dash-value" id="val-net-worth">$ 0</div>
                    <div class="dash-grid">
                        <div class="grid-item"><div class="grid-v" id="val-total-cash">$ 0</div><div class="grid-l">活存現金</div></div>
                        <div class="grid-item"><div class="grid-v" id="val-total-debt">$ 0</div><div class="grid-l">待收墊付</div></div>
                        <div class="grid-item"><div class="grid-v" id="val-total-count">0</div><div class="grid-l">帳戶數量</div></div>
                    </div>
                </div>
                <div class="card" onclick="app.openModal('modal-acc')" style="display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;">
                    <span style="color:var(--sub); font-size:12px;">快速管理</span>
                    <strong style="color:var(--primary); font-size:18px; margin-top:5px;">帳戶設定</strong>
                </div>
            </div>

            <div class="section-header">年度手帳 <span class="action-text" onclick="app.addYear()">+ 新增年度</span></div>
            <div id="year-list" class="responsive-grid"></div>
            
            <div class="section-header">資產帳戶明細</div>
            <div id="asset-list" class="responsive-grid"></div>

            <div class="section-header">常用功能</div>
            <div class="quick-grid">
                <div class="quick-btn" onclick="app.openModal('modal-transfer')" style="border-color:var(--blue); color:var(--blue);">
                    <strong>⇄ 跨帳戶轉帳</strong>
                </div>
                <div class="quick-btn" onclick="app.exportData()" style="border-style:dashed;">
                    <span>備份</span><strong>匯出資料</strong>
                </div>
            </div>
        </div>

        <!-- Months Page -->
        <div id="page-months" class="page">
            <div style="color:var(--sub); cursor:pointer; margin-bottom:20px;" onclick="app.showPage('page-home')">← 返回年度列表</div>
            <h2 id="disp-year" style="font-weight: 300; font-size: clamp(24px, 4vw, 36px); margin-bottom: 30px;"></h2>
            <div id="month-grid" class="month-grid"></div>
        </div>

        <!-- Detail Page -->
        <div id="page-detail" class="page" style="padding-top:20px">
            <div class="dashboard-container">
                <div class="dashboard">
                    <div onclick="app.showPage('page-months')" style="font-size:12px; opacity:0.6; margin-bottom:15px; cursor:pointer;">← 月份列表</div>
                    <div class="dash-label">本月可用預算 (實領薪資 - 固定/儲蓄)</div>
                    <div class="dash-value" id="val-budget">$ 0</div>
                    <div class="dash-grid">
                        <div class="grid-item"><div class="grid-v" id="val-save">$ 0</div><div class="grid-l">計畫儲蓄</div></div>
                        <div class="grid-item"><div class="grid-v" id="val-fixed">$ 0</div><div class="grid-l">固定支出</div></div>
                        <div class="grid-item"><div class="grid-v" id="val-spent" style="color:#ffcccc">$ 0</div><div class="grid-l">日常消費</div></div>
                    </div>
                </div>
                <div class="card" style="display:flex; flex-direction:column; justify-content:center;">
                    <div style="font-size:11px; color:var(--sub); margin-bottom:10px;">本月生活紀錄</div>
                    <textarea id="input-reflection" placeholder="寫下心情或待辦..." onblur="app.saveReflection(this.value)" style="margin:0; min-height:100px; border:none; background:transparent; padding:0; resize:none;"></textarea>
                </div>
            </div>

            <div class="detail-main-grid">
                <!-- 左側：支出錄入與預算列表 -->
                <div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h2 id="disp-month" style="font-weight:300;"></h2>
                        <div onclick="app.openModal('modal-income')" style="font-size:11px; border:1px solid #eee; padding:8px 16px; border-radius:12px; background: white; cursor:pointer;">薪資分配</div>
                    </div>

                    <div class="section-header">帳戶支出</div>
                    <div class="quick-grid" id="quick-btns" style="margin-bottom:30px;"></div>

                    <div class="section-header">預算與計畫 <span class="action-text" onclick="app.openModal('modal-plan')">+ 新增</span></div>
                    <div id="plan-list"></div>
                    
                    <div id="monthly-summary"></div>
                </div>

                <!-- 右側：記帳明細 -->
                <div>
                    <div class="section-header">記帳明細 (最新在最前)</div>
                    <div id="log-list"></div>
                </div>
            </div>
        </div>

        <nav class="nav">
            <div class="nav-inner">
                <div class="nav-item active" onclick="app.showPage('page-home')">總覽</div>
                <div class="nav-item" onclick="app.openModal('modal-acc')">帳戶</div>
                <div class="nav-item" onclick="app.exportData()">備份</div>
            </div>
        </nav>
    </div>

    <!-- Modals (Remain largely same logic, improved responsiveness) -->
    <div id="modal-log" class="modal"><div class="modal-content">
        <h3 id="log-title">記帳</h3>
        <div class="mode-toggle-group">
            <div id="mode-debt" class="mode-btn debt" onclick="app.setLogMode('debt')">負債 (墊付)</div>
            <div id="mode-repay" class="mode-btn repay" onclick="app.setLogMode('repay')">還債 (收回)</div>
        </div>
        <div id="log-chips" class="chip-group"></div>
        <input type="text" id="in-l-nc" placeholder="+ 新分類">
        <input type="number" id="in-l-amt" placeholder="金額" inputmode="decimal">
        <input type="text" id="in-l-note" placeholder="備註 (選填)">
        <button class="btn" onclick="app.saveLog()">確認記帳</button>
        <button class="btn btn-ghost" onclick="app.closeModal('modal-log')">取消</button>
    </div></div>

    <div id="modal-income" class="modal"><div class="modal-content">
        <h3>薪資與分配</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <input type="number" id="in-inc-base" placeholder="底薪" oninput="app.calcSalaryTotal()">
            <input type="number" id="in-inc-bonus" placeholder="獎金" oninput="app.calcSalaryTotal()">
        </div>
        <div style="background:#f9f9f9; padding:20px; border-radius:20px; margin-bottom:15px;">
            <div id="alloc-warning" style="color:var(--red); font-size:11px; display:none;">⚠ 餘額不為零</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <select id="in-inc-a-acc" onchange="app.calcSalaryTotal()"></select>
                <input type="number" id="in-inc-a-amt" placeholder="金額" oninput="app.calcSalaryTotal()">
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <select id="in-inc-b-acc" onchange="app.calcSalaryTotal()"></select>
                <input type="number" id="in-inc-b-amt" placeholder="金額" oninput="app.calcSalaryTotal()">
            </div>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <small>待分配：<strong id="salary-remain-preview">0</strong></small>
            <small>總計：<strong id="salary-total-preview">0</strong></small>
        </div>
        <button id="btn-save-income" class="btn" onclick="app.saveIncome()">確認儲存</button>
        <button class="btn btn-ghost" onclick="app.closeModal('modal-income')">取消</button>
    </div></div>

    <div id="modal-acc" class="modal"><div class="modal-content">
        <h3>帳戶管理</h3>
        <div id="acc-list"></div>
        <input type="text" id="in-a-name" placeholder="名稱 (如：上海、中信)">
        <input type="number" id="in-a-bal" placeholder="當前餘額">
        <button class="btn" onclick="app.saveAcc()">新增帳戶</button>
        <button class="btn btn-ghost" onclick="app.closeModal('modal-acc')">關閉</button>
    </div></div>

    <div id="modal-plan" class="modal"><div class="modal-content">
        <h3>預算計畫</h3>
        <input type="text" id="in-p-name" placeholder="名稱">
        <input type="number" id="in-p-amt" placeholder="金額">
        <select id="in-p-type"><option value="固定">固定支出</option><option value="存款">計畫儲蓄</option></select>
        <select id="in-p-acc"></select>
        <button class="btn" onclick="app.savePlan()">加入計畫</button>
        <button class="btn btn-ghost" onclick="app.closeModal('modal-plan')">取消</button>
    </div></div>

    <div id="modal-transfer" class="modal"><div class="modal-content">
        <h3>跨帳戶轉帳</h3>
        <select id="in-t-from"></select>
        <select id="in-t-to"></select>
        <input type="number" id="in-t-amt" placeholder="金額">
        <button class="btn" onclick="app.executeTransfer()" style="background:var(--blue);">執行轉帳</button>
        <button class="btn btn-ghost" onclick="app.closeModal('modal-transfer')">取消</button>
    </div></div>

    <script>
        const calc = {
            expr: "",
            input(v) { if (this.expr === "0" && v !== ".") this.expr = ""; this.expr += v; this.update(); },
            clear() { this.expr = "0"; this.update(); },
            del() { this.expr = this.expr.slice(0, -1) || "0"; this.update(); },
            equal() { try { const res = eval(this.expr); this.expr = String(Math.round(res * 100) / 100); } catch { this.expr = "Error"; } this.update(); },
            update() { document.getElementById('calc-display').innerText = this.expr || "0"; }
        };

        const ui = {
            toggleCalc() {
                const box = document.getElementById('calc-box');
                box.style.display = (box.style.display === 'flex') ? 'none' : 'flex';
            }
        };

        const app = {
            STORAGE_KEY: 'chun_finance_v9_responsive',
            state: {
                years: ["2026", "2025"],
                accounts: [
                    {name: "現金", bal: 0}, 
                    {name: "中信", bal: 0}, 
                    {name: "上海", bal: 0}
                ],
                categories: ["食", "衣", "住", "行", "育", "樂"],
                monthly: {}
            },
            context: { year: "2026", month: "一月", account: "", category: "食", mode: "normal" },

            init() {
                const data = localStorage.getItem(this.STORAGE_KEY);
                if (data) this.state = JSON.parse(data);
                this.render();
                setTimeout(() => {
                    document.getElementById('splash').style.opacity = '0';
                    document.getElementById('app-content').classList.add('visible');
                    setTimeout(() => document.getElementById('splash').style.display = 'none', 600);
                }, 800);
            },

            save() { localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.state)); this.render(); },

            showPage(id) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                window.scrollTo(0,0);
            },

            openModal(id, acc) {
                if(acc) {
                    this.context.account = acc;
                    this.context.mode = "normal";
                    document.getElementById('log-title').innerText = `${acc} 支出`;
                    this.updateLogModeUI();
                    this.renderChips();
                }
                const dropdowns = { 'modal-income': ['in-inc-a-acc', 'in-inc-b-acc'], 'modal-transfer': ['in-t-from', 'in-t-to'], 'modal-plan': ['in-p-acc'] };
                if(dropdowns[id]) this.populateAccs(dropdowns[id]);
                if(id === 'modal-income') this.loadIncomeData();
                document.getElementById(id).style.display = 'flex';
            },

            closeModal(id) { document.getElementById(id).style.display = 'none'; },

            populateAccs(ids) {
                const html = this.state.accounts.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
                ids.forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerHTML = html; });
            },

            setLogMode(mode) {
                this.context.mode = (this.context.mode === mode) ? "normal" : mode;
                this.updateLogModeUI();
            },

            updateLogModeUI() {
                const dBtn = document.getElementById('mode-debt');
                const rBtn = document.getElementById('mode-repay');
                dBtn.classList.toggle('active', this.context.mode === 'debt');
                rBtn.classList.toggle('active', this.context.mode === 'repay');
            },

            render() {
                const key = `${this.context.year}-${this.context.month}`;
                const d = this.state.monthly[key] || { income: 0, plans: [], logs: [] };
                
                // Home Stats
                const netWorth = this.state.accounts.reduce((s, a) => s + a.bal, 0);
                document.getElementById('val-net-worth').innerText = `$${netWorth.toLocaleString()}`;
                document.getElementById('val-total-cash').innerText = `$${netWorth.toLocaleString()}`;
                document.getElementById('val-total-count').innerText = this.state.accounts.length;

                // Lists
                document.getElementById('year-list').innerHTML = this.state.years.map(y => `<div class="card" onclick="app.enterYear('${y}')"><strong>${y} 年度理財手帳</strong></div>`).join('');
                document.getElementById('asset-list').innerHTML = this.state.accounts.map(a => `<div class="card" style="display:flex; justify-content:space-between"><span>${a.name}</span><strong>$${a.bal.toLocaleString()}</strong></div>`).join('');

                // Detail Page Calculation
                const fixed = (d.plans || []).filter(p => p.type==='固定').reduce((s, p) => s + p.amt, 0);
                const save = (d.plans || []).filter(p => p.type==='存款').reduce((s, p) => s + p.amt, 0);
                let dailySpent = 0;
                let pendingDebt = 0;
                (d.logs || []).forEach(l => {
                    if(!l.isTransfer && !l.isDebt && !l.isRepay) dailySpent += l.amt;
                    if(l.isDebt) pendingDebt += l.amt;
                    if(l.isRepay) pendingDebt -= l.amt;
                });

                const budget = d.income - fixed - save;
                const remainingBudget = budget - dailySpent;

                document.getElementById('val-budget').innerText = `$${remainingBudget.toLocaleString()}`;
                document.getElementById('val-fixed').innerText = `$${fixed.toLocaleString()}`;
                document.getElementById('val-save').innerText = `$${save.toLocaleString()}`;
                document.getElementById('val-spent').innerText = `$${dailySpent.toLocaleString()}`;
                document.getElementById('val-total-debt').innerText = `$${pendingDebt.toLocaleString()}`;

                document.getElementById('disp-year').innerText = this.context.year;
                document.getElementById('disp-month').innerText = `${this.context.year} · ${this.context.month}`;
                
                const ms = ["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"];
                document.getElementById('month-grid').innerHTML = ms.map(m => `<div class="card" style="text-align:center" onclick="app.enterMonth('${m}')"><strong>${m}</strong></div>`).join('');

                document.getElementById('quick-btns').innerHTML = this.state.accounts.map(a => `<div class="quick-btn" onclick="app.openModal('modal-log', '${a.name}')"><span>${a.name}</span><strong>支出 +</strong></div>`).join('');
                
                document.getElementById('plan-list').innerHTML = (d.plans || []).map((p, i) => `<div class="card" style="padding:15px; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span><span class="tag ${p.type==='固定'?'t-fixed':'t-save'}">${p.type}</span>${p.name}</span>
                        <strong>$${p.amt.toLocaleString()} <span onclick="app.delPlan(${i})" style="color:#eee; margin-left:10px; cursor:pointer;">✕</span></strong>
                    </div>
                </div>`).join('');

                document.getElementById('log-list').innerHTML = (d.logs || []).map((l, i) => {
                    let tagClass = l.isDebt ? "t-debt" : (l.isRepay ? "t-repay" : "");
                    const color = l.isRepay ? 'var(--green)' : (l.isDebt ? 'var(--red)' : (l.isTransfer ? 'var(--blue)' : 'var(--text)'));
                    return `<div class="card" style="padding:15px; margin-bottom:12px; cursor:default;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                ${tagClass ? `<span class="tag ${tagClass}">${l.isDebt?'墊付':'還債'}</span>` : ''}
                                <strong>${l.cate}</strong> 
                                <div style="font-size:12px; color:var(--sub)">${l.note||''}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="color:${color}; font-weight:700; font-size:16px;">${l.isRepay?'+':'-'}$${l.amt.toLocaleString()}</div>
                                <div style="font-size:10px; color:#ccc;">${l.acc} · <span onclick="app.undoLog(${i})" style="color:var(--primary); cursor:pointer;">撤銷</span></div>
                            </div>
                        </div>
                    </div>`;
                }).reverse().join('');

                document.getElementById('acc-list').innerHTML = this.state.accounts.map((a, i) => `<div style="display:flex; justify-content:space-between; padding:15px 0; border-bottom:1px solid #eee;"><span>${a.name} ($${a.bal.toLocaleString()})</span><span onclick="app.delAcc(${i})" style="color:var(--red); font-size:12px; cursor:pointer;">✕ 刪除</span></div>`).join('');
                
                document.getElementById('monthly-summary').innerHTML = `
                    <div class="summary-card">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>實領薪資</span><strong>$${d.income.toLocaleString()}</strong></div>
                        <div style="display:flex; justify-content:space-between; border-top:1px solid var(--border); padding-top:10px;"><span>本月預算餘額</span><strong style="color:${remainingBudget<0?'var(--red)':'var(--green)'}">$${remainingBudget.toLocaleString()}</strong></div>
                    </div>
                `;
                
                document.getElementById('input-reflection').value = d.reflection || "";
            },

            // Other logic remains unchanged from previous version to ensure functional stability
            saveLog() {
                const a = parseFloat(document.getElementById('in-l-amt').value);
                const nc = document.getElementById('in-l-nc').value.trim();
                const cate = nc || this.context.category;
                if(!a) return;
                
                if(nc && !this.state.categories.includes(nc)) this.state.categories.push(nc);
                const acc = this.state.accounts.find(x => x.name === this.context.account);
                
                let isDebt = this.context.mode === 'debt';
                let isRepay = this.context.mode === 'repay';
                
                if(acc) {
                    if(isRepay) acc.bal += a;
                    else acc.bal -= a;
                }

                const key = `${this.context.year}-${this.context.month}`;
                if(!this.state.monthly[key]) this.state.monthly[key] = {income:0, plans:[], logs:[]};
                
                this.state.monthly[key].logs.push({
                    acc: this.context.account, cate: isDebt ? "代墊款項" : (isRepay ? "還債收回" : cate), 
                    amt: a, note: document.getElementById('in-l-note').value, date: new Date().toLocaleDateString(),
                    isDebt, isRepay
                });

                this.save(); this.closeModal('modal-log');
                document.getElementById('in-l-amt').value=""; document.getElementById('in-l-nc').value=""; document.getElementById('in-l-note').value="";
            },

            calcSalaryTotal() {
                const b = parseFloat(document.getElementById('in-inc-base').value) || 0;
                const bo = parseFloat(document.getElementById('in-inc-bonus').value) || 0;
                const total = b + bo;
                const aAmt = parseFloat(document.getElementById('in-inc-a-amt').value) || 0;
                const bAmt = parseFloat(document.getElementById('in-inc-b-amt').value) || 0;
                const remain = total - (aAmt + bAmt);

                document.getElementById('salary-total-preview').innerText = `$ ${total.toLocaleString()}`;
                document.getElementById('salary-remain-preview').innerText = `$ ${remain.toLocaleString()}`;
                document.getElementById('btn-save-income').disabled = (remain !== 0);
                return total;
            },

            saveIncome() {
                const total = this.calcSalaryTotal();
                const key = `${this.context.year}-${this.context.month}`;
                if(!this.state.monthly[key]) this.state.monthly[key] = {income:0, plans:[], logs:[]};
                
                const aN = document.getElementById('in-inc-a-acc').value;
                const aV = parseFloat(document.getElementById('in-inc-a-amt').value) || 0;
                const bN = document.getElementById('in-inc-b-acc').value;
                const bV = parseFloat(document.getElementById('in-inc-b-amt').value) || 0;

                const accA = this.state.accounts.find(x => x.name === aN);
                const accB = this.state.accounts.find(x => x.name === bN);
                if(accA) accA.bal += aV; if(accB) accB.bal += bV;

                this.state.monthly[key].income = total;
                this.save(); this.closeModal('modal-income');
            },

            loadIncomeData() {
                const key = `${this.context.year}-${this.context.month}`;
                const m = this.state.monthly[key] || {};
                document.getElementById('in-inc-base').value = m.income || 0;
                this.calcSalaryTotal();
            },

            saveReflection(v) {
                const key = `${this.context.year}-${this.context.month}`;
                if(!this.state.monthly[key]) this.state.monthly[key] = {income:0, plans:[], logs:[]};
                this.state.monthly[key].reflection = v;
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.state));
            },

            undoLog(i) {
                const key = `${this.context.year}-${this.context.month}`;
                const l = this.state.monthly[key].logs[i];
                const acc = this.state.accounts.find(x => x.name === l.acc);
                if(acc) { if(l.isRepay) acc.bal -= l.amt; else acc.bal += l.amt; }
                this.state.monthly[key].logs.splice(i,1); this.save();
            },

            executeTransfer() {
                const f = document.getElementById('in-t-from').value;
                const t = document.getElementById('in-t-to').value;
                const a = parseFloat(document.getElementById('in-t-amt').value);
                if(!a || f === t) return;
                const accF = this.state.accounts.find(x => x.name === f);
                const accT = this.state.accounts.find(x => x.name === t);
                if(accF && accT) { accF.bal -= a; accT.bal += a; }
                const key = `${this.context.year}-${this.context.month}`;
                if(!this.state.monthly[key]) this.state.monthly[key] = {income:0, plans:[], logs:[]};
                this.state.monthly[key].logs.push({acc:f, cate:"帳戶轉出", amt:a, note:`轉至 ${t}`, date:new Date().toLocaleDateString(), isTransfer:true});
                this.state.monthly[key].logs.push({acc:t, cate:"帳戶轉入", amt:a, note:`來自 ${f}`, date:new Date().toLocaleDateString(), isTransfer:true, isRepay:true});
                this.save(); this.closeModal('modal-transfer');
            },

            renderChips() { document.getElementById('log-chips').innerHTML = this.state.categories.map(c => `<div class="chip ${this.context.category === c ? 'active' : ''}" onclick="app.selectCate('${c}')">${c}</div>`).join(''); },
            selectCate(c) { this.context.category = c; this.renderChips(); },
            enterYear(y) { this.context.year = y; this.showPage('page-months'); this.render(); },
            enterMonth(m) { this.context.month = m; this.showPage('page-detail'); this.render(); },
            addYear() { const y = prompt("年度:"); if(y) { this.state.years.unshift(y); this.save(); } },
            saveAcc() { const n = document.getElementById('in-a-name').value; const b = parseFloat(document.getElementById('in-a-bal').value) || 0; if(n){this.state.accounts.push({name:n, bal:b}); this.save();}},
            delAcc(i) { if(confirm("刪除帳戶？")) { this.state.accounts.splice(i,1); this.save(); } },
            savePlan() {
                const n = document.getElementById('in-p-name').value;
                const a = parseFloat(document.getElementById('in-p-amt').value) || 0;
                const accN = document.getElementById('in-p-acc').value;
                const acc = this.state.accounts.find(x => x.name === accN);
                if(acc) acc.bal -= a;
                const key = `${this.context.year}-${this.context.month}`;
                if(!this.state.monthly[key]) this.state.monthly[key] = {income:0, plans:[], logs:[]};
                this.state.monthly[key].plans.push({name:n, amt:a, type:document.getElementById('in-p-type').value, acc:accN});
                this.save(); this.closeModal('modal-plan');
            },
            delPlan(i) {
                const key = `${this.context.year}-${this.context.month}`;
                const p = this.state.monthly[key].plans[i];
                const acc = this.state.accounts.find(x => x.name === p.acc);
                if(acc) acc.bal += p.amt;
                this.state.monthly[key].plans.splice(i,1); this.save();
            },
            exportData() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.state));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "chun_finance_backup.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
